<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="robots" content="noindex,nofollow" />
  <title>Inbox Dashboard</title>
  <style>
    :root {
      color-scheme: light;
      --bg: #f5f7fb;
      --surface: #ffffff;
      --border: #e4e7ec;
      --text-strong: #0f172a;
      --text-muted: #475569;
      --accent: #0f766e;
      --accent-soft: #cffafe;
      font-family: "Inter", "Segoe UI", system-ui, sans-serif;
      --radius: 12px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: var(--bg);
      color: var(--text-strong);
    }

    main {
      width: min(960px, 100%);
      margin: 0 auto;
      padding: 1.5rem 1.25rem 3rem;
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }

    header {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    header h1 {
      margin: 0;
      font-size: 1.75rem;
    }

    header p {
      margin: 0;
      color: var(--text-muted);
      font-size: 0.95rem;
    }

    .filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 0.5rem;
    }

    .filters button {
      border: 1px solid var(--border);
      border-radius: 999px;
      background: #fff;
      color: var(--text-muted);
      font-weight: 600;
      padding: 0.65rem 0.9rem;
      cursor: pointer;
      transition: 0.2s ease;
      width: 100%;
    }

    .filters button.active {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }

    .filters .range-inputs {
      display: flex;
      gap: 0.5rem;
      grid-column: 1 / -1;
    }

    .filters input[type="date"] {
      flex: 1;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 0.55rem 0.75rem;
      background: #fff;
    }

    .filters button.apply {
      background: var(--accent);
      color: #fff;
    }

    .status-tag {
      align-self: flex-start;
      padding: 0.5rem 0.9rem;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
      font-size: 0.8rem;
      font-weight: 600;
    }

    .metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 0.75rem;
    }

    .metric-card {
      background: #fff;
      border-radius: var(--radius);
      padding: 1rem 1rem 0.85rem;
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .metric-card__title {
      font-size: 0.75rem;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--text-muted);
      margin: 0;
    }

    .metric-card__value {
      font-size: 1.9rem;
      font-weight: 600;
      margin: 0;
    }

    .metric-card__caption {
      margin: 0;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .insights {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 0.85rem;
    }

    .insight-card {
      background: #fff;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .insight-card header {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .insight-card header h2 {
      margin: 0;
      font-size: 1rem;
    }

    .insight-card header p {
      margin: 0;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .insight-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 0.45rem;
    }

    .insight-list li {
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
      font-size: 0.9rem;
    }

    .panel {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1rem 1.2rem;
      box-shadow: 0 18px 45px -30px rgba(15, 23, 42, 0.7);
    }

    .email-panel header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }

    .email-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    .email-table th,
    .email-table td {
      padding: 0.5rem 0.4rem;
      border-bottom: 1px solid var(--border);
      text-align: left;
    }

    .email-table thead {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.2px;
      color: #334155;
    }

    .pagination {
      margin-top: 0.85rem;
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      font-size: 0.85rem;
      flex-wrap: wrap;
    }

    .pagination button {
      border: 1px solid var(--border);
      background: #fff;
      border-radius: var(--radius);
      padding: 0.45rem 0.9rem;
      font-weight: 600;
      cursor: pointer;
    }

    .email-status {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin: 0;
    }

    @media (max-width: 600px) {
      .filters .range-inputs {
        flex-direction: column;
      }
      .email-table th,
      .email-table td {
        font-size: 0.75rem;
      }
      .panel {
        padding: 0.9rem 1rem;
      }
    }
  </style>
</head>
<body>
  <main>
    <header>
      <h1>Inbox dashboard</h1>
      <p>Live metrics and paginated list of incoming messages.</p>
      <span class="status-tag" id="status-text">Waiting for data...</span>
    </header>

    <div class="filters">
      <button data-range="day" class="active">Today</button>
      <button data-range="yesterday">Yesterday</button>
      <button data-range="week">Week</button>
      <button data-range="month">Month</button>
      <div class="range-inputs">
        <input type="date" id="custom-start" />
        <input type="date" id="custom-end" />
        <button class="apply" id="apply-range">Apply</button>
      </div>
    </div>

    <div class="metrics">
      <article class="metric-card">
        <p class="metric-card__title">Total received</p>
        <p class="metric-card__value" id="metric-total">-</p>
        <p class="metric-card__caption">Records within the active range.</p>
      </article>
      <article class="metric-card">
        <p class="metric-card__title">Busiest day</p>
        <p class="metric-card__value" id="metric-busiest">-</p>
        <p class="metric-card__caption" id="metric-busiest-caption">Last updated timestamp.</p>
      </article>
    </div>

    <div class="insights">
      <article class="insight-card">
        <header>
          <h2>Top sender domains</h2>
          <p>Where messages arrive most frequently.</p>
        </header>
        <ul class="insight-list" id="top-domains">
          <li class="empty">Insight data is not available yet.</li>
        </ul>
      </article>
      <article class="insight-card">
        <header>
          <h2>Repeated recipients</h2>
          <p>Email addresses triggered multiple times.</p>
        </header>
        <ul class="insight-list" id="repeated-recipients">
          <li class="empty">Insight data is not available yet.</li>
        </ul>
      </article>
    </div>

    <section class="panel email-panel">
      <header>
        <div>
          <h2 style="margin:0; font-size:1.1rem;">Emails</h2>
          <p class="email-status" id="email-status">Loading emails...</p>
        </div>
      </header>
      <div class="table-wrapper">
        <table class="email-table">
          <thead>
            <tr>
              <th>Received</th>
              <th>From</th>
              <th>To</th>
              <th>Subject</th>
              <th>ID</th>
            </tr>
          </thead>
          <tbody id="email-rows">
            <tr>
              <td colspan="5" style="text-align:center;">Waiting for data...</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="pagination">
        <button id="prev-page">Previous</button>
        <span id="page-indicator">Page 1</span>
        <button id="next-page">Next</button>
      </div>
    </section>
  </main>

  <script>
    const statusText = document.getElementById("status-text");
    const metricTotal = document.getElementById("metric-total");
    const metricBusiest = document.getElementById("metric-busiest");
    const busiestCaption = document.getElementById("metric-busiest-caption");
    const emailRows = document.getElementById("email-rows");
    const emailStatus = document.getElementById("email-status");
    const prevBtn = document.getElementById("prev-page");
    const nextBtn = document.getElementById("next-page");
    const pageIndicator = document.getElementById("page-indicator");
    const topDomainsList = document.getElementById("top-domains");
    const repeatedRecipientsList = document.getElementById("repeated-recipients");

    const ranges = document.querySelectorAll(".filters button[data-range]");
    const startInput = document.getElementById("custom-start");
    const endInput = document.getElementById("custom-end");
    const applyBtn = document.getElementById("apply-range");

    let currentPage = 1;
    const pageSize = 12;
    let currentQuery = "";

    const setStatus = (text) => {
      if (statusText) statusText.textContent = text;
    };

    const formatDate = (date) => {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, "0");
      const day = String(date.getDate()).padStart(2, "0");
      return `${year}-${month}-${day}`;
    };

    const buildRange = (range) => {
      const now = new Date();
      switch (range) {
        case "yesterday": {
          const yesterday = new Date(now);
          yesterday.setDate(yesterday.getDate() - 1);
          const value = formatDate(yesterday);
          return { start: value, end: value };
        }
        case "week": {
          const weekStart = new Date(now);
          weekStart.setDate(weekStart.getDate() - 6);
          return { start: formatDate(weekStart), end: formatDate(now) };
        }
        case "month": {
          const monthStart = new Date(now);
          monthStart.setDate(1);
          return { start: formatDate(monthStart), end: formatDate(now) };
        }
        default:
          const today = formatDate(now);
          return { start: today, end: today };
      }
    };

    const normalizeQuery = (query) => {
      if (!query) return "";
      return query.startsWith("?") ? query : `?${query}`;
    };

    const renderList = (element, data, emptyText) => {
      if (!element) return;
      if (!Array.isArray(data) || !data.length) {
        element.innerHTML = `<li class="empty">${emptyText}</li>`;
        return;
      }
      element.innerHTML = data
        .map((item) => {
          const label = item.domain || item.recipient || "�";
          return `<li><span>${label}</span><span>x${item.count}</span></li>`;
        })
        .join("");
    };

    const fetchEmailList = async (query = "") => {
      emailStatus.textContent = "Loading emails...";
      emailRows.innerHTML = `<tr><td colspan=\"5\" style=\"text-align:center;\">Loading emails...</td></tr>`;
      try {
        const normalized = normalizeQuery(query);
        const separator = normalized ? (normalized.includes("?") ? "&" : "?") : "?";
        const response = await fetch(`/dashboard-emails${normalized}${separator}page=${currentPage}&pageSize=${pageSize}`);
        if (!response.ok) throw new Error("Unable to load emails");
        const data = await response.json();
        const rows = data.emails
          .map((email) => {
            const received = email.created_at ? new Date(email.created_at).toLocaleString() : "�";
            const subject = email.subject ? email.subject.replace(/</g, "&lt;").replace(/>/g, "&gt;") : "�";
            return `<tr>
              <td>${received}</td>
              <td>${email.from_email || "�"}</td>
              <td>${email.to_email || "�"}</td>
              <td>${subject}</td>
              <td>${email.id.slice(-6)}</td>
            </tr>`;
          })
          .join("");
        emailRows.innerHTML = rows || `<tr><td colspan=\"5\" style=\"text-align:center;\">No emails for this range.</td></tr>`;
        emailStatus.textContent = `${data.emails.length} of ${data.total} showing`;
        pageIndicator.textContent = `Page ${currentPage}`;
        prevBtn.disabled = currentPage <= 1;
        nextBtn.disabled = data.emails.length < pageSize || data.total <= currentPage * pageSize;
      } catch (err) {
        emailRows.innerHTML = `<tr><td colspan=\"5\" style=\"text-align:center; color:#b91c1c;\">${err.message}</td></tr>`;
        emailStatus.textContent = "Unable to load emails.";
      }
    };

    const fetchStats = async (query = "") => {
      setStatus("Loading stats...");
      try {
        const response = await fetch(`/dashboard-data${normalizeQuery(query)}`);
        if (!response.ok) throw new Error("Unable to load stats");
        const data = await response.json();
        metricTotal.textContent = data.filtered ?? data.today ?? "0";
        metricBusiest.textContent = data.filtered !== null ? formatDate(new Date()) : "�";
        busiestCaption.textContent = data.filtered !== null ? `Based on ${data.filtered} messages.` : "New data will fill here.";
        renderList(topDomainsList, data.topDomains, "Insight data is not available yet.");
        renderList(repeatedRecipientsList, data.repeatedRecipients, "Insight data is not available yet.");
        setStatus(`Updated ${new Date().toLocaleTimeString()}`);
        currentQuery = normalizeQuery(query);
        currentPage = 1;
        await fetchEmailList(currentQuery);
      } catch (err) {
        console.error(err);
        metricTotal.textContent = "�";
        metricBusiest.textContent = "�";
        busiestCaption.textContent = err.message;
        renderList(topDomainsList, [], "Insight data is not available yet.");
        renderList(repeatedRecipientsList, [], "Insight data is not available yet.");
        setStatus(err.message || "Unable to load stats");
      }
    };

    const setActiveRange = (range) => {
      ranges.forEach((btn) => btn.classList.toggle("active", btn.dataset.range === range));
    };

    ranges.forEach((btn) => {
      btn.addEventListener("click", () => {
        setActiveRange(btn.dataset.range);
        const { start, end } = buildRange(btn.dataset.range);
        fetchStats(`?startDate=${start}&endDate=${end}`);
      });
    });

    applyBtn.addEventListener("click", () => {
      const start = startInput.value;
      const end = endInput.value;
      if (!start || !end) return;
      setActiveRange("");
      fetchStats(`?startDate=${start}&endDate=${end}`);
    });

    prevBtn.addEventListener("click", () => {
      if (currentPage > 1) {
        currentPage -= 1;
        fetchEmailList(currentQuery);
      }
    });

    nextBtn.addEventListener("click", () => {
      currentPage += 1;
      fetchEmailList(currentQuery);
    });

    fetchStats("?");
  </script>
</body>
</html>
