<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Email Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      color: #1a1a1a;
      padding: 12px;
      min-height: 100vh;
    }

    .container {
      max-width: 480px;
      margin: 0 auto;
    }

    .header {
      margin-bottom: 12px;
    }

    .title {
      font-size: 18px;
      font-weight: 600;
      color: #000;
      margin-bottom: 2px;
    }

    .subtitle {
      font-size: 11px;
      color: #666;
    }

    .filters {
      background: #fff;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 10px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    .filters-label {
      font-size: 10px;
      color: #999;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .chip {
      padding: 6px 12px;
      font-size: 11px;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
      background: #fafafa;
      color: #333;
      cursor: pointer;
      transition: all 0.15s;
      font-weight: 500;
    }

    .chip:active {
      transform: scale(0.98);
    }

    .chip.active {
      background: #000;
      color: #fff;
      border-color: #000;
    }

    .card {
      background: #fff;
      border-radius: 8px;
      padding: 14px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    .card-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
      padding-bottom: 10px;
      border-bottom: 1px solid #f0f0f0;
    }

    .card-label {
      font-size: 11px;
      color: #666;
      margin-bottom: 2px;
    }

    .card-range {
      font-size: 10px;
      color: #999;
    }

    .live-badge {
      font-size: 9px;
      padding: 3px 7px;
      border-radius: 4px;
      background: #f0f0f0;
      color: #666;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .live-dot {
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: #22c55e;
    }

    .count-display {
      margin-bottom: 10px;
    }

    .count-value {
      font-size: 32px;
      font-weight: 700;
      color: #000;
      line-height: 1;
    }

    .count-label {
      font-size: 11px;
      color: #999;
      margin-left: 4px;
    }

    .status-bar {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #f0f0f0;
      margin-bottom: 12px;
    }

    .status {
      font-size: 10px;
      color: #666;
    }

    .status.error {
      color: #ef4444;
    }

    .status.loading {
      color: #3b82f6;
    }

    .refresh-text {
      font-size: 9px;
      color: #ccc;
    }

    .section {
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid #f0f0f0;
    }

    .section:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .section-title {
      font-size: 10px;
      font-weight: 600;
      color: #333;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .section-note {
      font-size: 9px;
      color: #ccc;
    }

    .list {
      max-height: 180px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .list-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      font-size: 11px;
      border-bottom: 1px solid #f8f8f8;
    }

    .list-row:last-child {
      border-bottom: none;
    }

    .list-left {
      color: #333;
      font-weight: 500;
    }

    .list-right {
      color: #999;
      font-weight: 600;
    }

    .empty {
      font-size: 10px;
      color: #999;
      padding: 8px 0;
      text-align: center;
    }

    .list::-webkit-scrollbar {
      width: 4px;
    }

    .list::-webkit-scrollbar-track {
      background: #f8f8f8;
    }

    .list::-webkit-scrollbar-thumb {
      background: #ddd;
      border-radius: 2px;
    }

    @media (max-width: 400px) {
      body {
        padding: 10px;
      }

      .title {
        font-size: 16px;
      }

      .count-value {
        font-size: 28px;
      }

      .chip {
        font-size: 10px;
        padding: 5px 10px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 class="title">Email Dashboard</h1>
      <p class="subtitle">Track your email counts by date range</p>
    </div>

    <div class="filters">
      <div class="filters-label">Select Range</div>
      <div class="chips" id="chips">
        <button class="chip active" data-range="today">Today</button>
        <button class="chip" data-range="yesterday">Yesterday</button>
        <button class="chip" data-range="week">7 Days</button>
        <button class="chip" data-range="month">30 Days</button>
      </div>
    </div>

    <div class="card">
      <div class="card-top">
        <div>
          <div class="card-label" id="range-label">Today</div>
          <div class="card-range" id="range-detail"></div>
        </div>
        <div class="live-badge">
          <span class="live-dot"></span>
          Live
        </div>
      </div>

      <div class="count-display">
        <span class="count-value" id="count">0</span>
        <span class="count-label">emails</span>
      </div>

      <div class="status-bar">
        <div class="status" id="status">Loading...</div>
        <div class="refresh-text">Auto refresh</div>
      </div>

      <div class="section">
        <div class="section-header">
          <div class="section-title">Top Senders</div>
          <div class="section-note">&gt;2 emails</div>
        </div>
        <div id="senders" class="list"></div>
      </div>

      <div class="section">
        <div class="section-header">
          <div class="section-title">Daily Breakdown</div>
          <div class="section-note">Most recent first</div>
        </div>
        <div id="breakdown" class="list"></div>
      </div>
    </div>
  </div>

  <script>
    function getDubaiNow() {
      const now = new Date();
      const parts = new Intl.DateTimeFormat("en-US", {
        timeZone: "Asia/Dubai",
        year: "numeric",
        month: "numeric",
        day: "numeric",
        hour: "numeric",
        minute: "numeric",
        second: "numeric"
      }).formatToParts(now);

      const get = (type) => parseInt(parts.find(p => p.type === type).value, 10);

      return new Date(
        get("year"),
        get("month") - 1,
        get("day"),
        get("hour"),
        get("minute"),
        get("second")
      );
    }

    function formatDate(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, "0");
      const d = String(date.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    function formatShort(date) {
      return date.toLocaleDateString("en-US", { day: "numeric", month: "short" });
    }

    function formatFull(date) {
      return date.toLocaleDateString("en-US", { 
        day: "numeric", 
        month: "short", 
        year: "numeric" 
      });
    }

    function getDates(range) {
      const today = getDubaiNow();
      today.setHours(0, 0, 0, 0);
      
      if (range === "today") return [new Date(today)];
      
      if (range === "yesterday") {
        const y = new Date(today);
        y.setDate(y.getDate() - 1);
        return [y];
      }
      
      const days = range === "week" ? 7 : 30;
      const dates = [];
      for (let i = 0; i < days; i++) {
        const d = new Date(today);
        d.setDate(d.getDate() - i);
        dates.push(d);
      }
      return dates;
    }

    function getLabel(range) {
      const labels = {
        today: "Today",
        yesterday: "Yesterday",
        week: "Last 7 Days",
        month: "Last 30 Days"
      };
      return labels[range] || "Today";
    }

    function getDetail(dates) {
      if (!dates.length) return "";
      if (dates.length === 1) return formatFull(dates[0]);
      return `${formatFull(dates[dates.length - 1])} - ${formatFull(dates[0])}`;
    }

    async function fetchData(date) {
      const res = await fetch(`/email-count?date=${encodeURIComponent(date)}`);
      if (!res.ok) throw new Error(`API error ${res.status}`);
      const data = await res.json();
      return {
        count: data.count || 0,
        senders: Array.isArray(data.senders) ? data.senders : []
      };
    }

    function setActive(range) {
      document.querySelectorAll(".chip").forEach(chip => {
        chip.classList.toggle("active", chip.dataset.range === range);
      });
    }

    function setStatus(text, type = "") {
      const el = document.getElementById("status");
      el.textContent = text;
      el.className = `status ${type}`;
    }

    function renderSenders(metrics) {
      const el = document.getElementById("senders");
      const map = {};
      
      metrics.forEach(m => {
        m.senders.forEach(s => {
          if (s.email) {
            map[s.email] = (map[s.email] || 0) + (s.count || 0);
          }
        });
      });

      const entries = Object.entries(map)
        .map(([email, total]) => ({ email, total }))
        .filter(x => x.total > 2)
        .sort((a, b) => b.total - a.total);

      if (!entries.length) {
        el.innerHTML = '<div class="empty">No senders with &gt;2 emails</div>';
        return;
      }

      el.innerHTML = entries.map(x => `
        <div class="list-row">
          <div class="list-left">${x.email}</div>
          <div class="list-right">${x.total}</div>
        </div>
      `).join("");
    }

    function renderBreakdown(dates, metrics) {
      const el = document.getElementById("breakdown");
      
      if (!dates.length) {
        el.innerHTML = '<div class="empty">No data</div>';
        return;
      }

      el.innerHTML = dates.map((d, i) => `
        <div class="list-row">
          <div class="list-left">${formatFull(d)}</div>
          <div class="list-right">${metrics[i].count}</div>
        </div>
      `).join("");
    }

    async function load(range) {
      try {
        setStatus("Loading...", "loading");
        setActive(range);
        
        const dates = getDates(range);
        document.getElementById("range-label").textContent = getLabel(range);
        document.getElementById("range-detail").textContent = getDetail(dates);

        const metrics = await Promise.all(dates.map(d => fetchData(formatDate(d))));
        const total = metrics.reduce((sum, m) => sum + m.count, 0);
        
        document.getElementById("count").textContent = total;
        renderSenders(metrics);
        renderBreakdown(dates, metrics);
        setStatus("Updated now");
      } catch (err) {
        console.error(err);
        setStatus(`Error: ${err.message}`, "error");
        document.getElementById("senders").innerHTML = '<div class="empty">Error loading data</div>';
        document.getElementById("breakdown").innerHTML = '<div class="empty">Error loading data</div>';
      }
    }

    document.getElementById("chips").addEventListener("click", e => {
      const btn = e.target.closest(".chip");
      if (btn) load(btn.dataset.range);
    });

    load("today");
  </script>
</body>
</html>