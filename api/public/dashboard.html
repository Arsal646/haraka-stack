<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Email Count Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: #f5f5f5;
      color: #111;
      padding: 16px;
    }

    .container {
      max-width: 480px;
      margin: 0 auto;
    }

    .header {
      margin-bottom: 16px;
    }

    .title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .subtitle {
      font-size: 13px;
      color: #666;
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 16px 0;
    }

    .chip {
      padding: 6px 12px;
      font-size: 14px;
      border-radius: 999px;
      border: 1px solid #ddd;
      background: #fff;
      color: #333;
      cursor: pointer;
      transition: background 0.15s, color 0.15s, border-color 0.15s, transform 0.1s;
    }

    .chip:hover {
      transform: translateY(-1px);
    }

    .chip.active {
      background: #111827;
      color: #fff;
      border-color: #111827;
    }

    .card {
      background: #fff;
      border-radius: 16px;
      padding: 16px 18px;
      box-shadow:
        0 10px 15px rgba(0, 0, 0, 0.05),
        0 4px 6px rgba(0, 0, 0, 0.03);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 8px;
    }

    .card-title {
      font-size: 15px;
      font-weight: 500;
      color: #374151;
    }

    .card-range-label {
      font-size: 12px;
      color: #6b7280;
    }

    .count-row {
      display: flex;
      align-items: baseline;
      gap: 6px;
      margin: 4px 0 8px;
    }

    .count-value {
      font-size: 32px;
      font-weight: 700;
    }

    .count-unit {
      font-size: 13px;
      color: #6b7280;
    }

    .status {
      font-size: 12px;
      color: #6b7280;
    }

    .status.error {
      color: #b91c1c;
    }

    .status.loading {
      color: #2563eb;
    }

    @media (min-width: 600px) {
      body {
        padding-top: 32px;
      }

      .title {
        font-size: 22px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1 class="title">Email Count Dashboard</h1>
      <p class="subtitle">
        Quick view of emails received today, yesterday, this week, and this month.
      </p>
    </header>

    <div class="chip-row" id="range-chips">
      <button class="chip active" data-range="today">Today</button>
      <button class="chip" data-range="yesterday">Yesterday</button>
      <button class="chip" data-range="week">Week</button>
      <button class="chip" data-range="month">Month</button>
    </div>

    <section class="card">
      <div class="card-header">
        <span class="card-title">Total emails</span>
        <span class="card-range-label" id="range-label">Today</span>
      </div>
      <div class="count-row">
        <span class="count-value" id="count-value">0</span>
        <span class="count-unit">emails</span>
      </div>
      <p class="status" id="status-text">Loading data, please wait.</p>
    </section>
  </div>

  <script>
    const API_BASE = ""; // same origin. Example: "" so it calls /email-count

    const chipsContainer = document.getElementById("range-chips");
    const countValueEl = document.getElementById("count-value");
    const statusTextEl = document.getElementById("status-text");
    const rangeLabelEl = document.getElementById("range-label");

    function formatDate(date) {
      return date.toISOString().split("T")[0];
    }

    function getDatesForRange(range) {
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      if (range === "today") {
        return [formatDate(today)];
      }

      if (range === "yesterday") {
        const y = new Date(today);
        y.setDate(y.getDate() - 1);
        return [formatDate(y)];
      }

      if (range === "week") {
        // last 7 days including today
        const dates = [];
        for (let i = 0; i < 7; i++) {
          const d = new Date(today);
          d.setDate(d.getDate() - i);
          dates.push(formatDate(d));
        }
        return dates;
      }

      if (range === "month") {
        // last 30 days including today
        const dates = [];
        for (let i = 0; i < 30; i++) {
          const d = new Date(today);
          d.setDate(d.getDate() - i);
          dates.push(formatDate(d));
        }
        return dates;
      }

      return [formatDate(today)];
    }

    function labelForRange(range) {
      if (range === "today") return "Today";
      if (range === "yesterday") return "Yesterday";
      if (range === "week") return "Last 7 days";
      if (range === "month") return "Last 30 days";
      return "Today";
    }

    async function fetchCountForDate(dateStr) {
      const url = `${API_BASE}/email-count?date=${encodeURIComponent(dateStr)}`;
      const res = await fetch(url);
      if (!res.ok) {
        throw new Error(`API error, status ${res.status}`);
      }
      const data = await res.json();
      if (!data.ok) {
        throw new Error(data.error || "API returned error");
      }
      return typeof data.count === "number" ? data.count : 0;
    }

    async function loadRange(range) {
      try {
        setStatus("Loading data, please wait.", "loading");
        rangeLabelEl.textContent = labelForRange(range);
        setActiveChip(range);

        const dates = getDatesForRange(range);
        let total = 0;

        for (const d of dates) {
          const c = await fetchCountForDate(d);
          total += c;
        }

        countValueEl.textContent = total.toString();
        const now = new Date();
        setStatus("Updated at " + now.toLocaleTimeString(), "normal");
      } catch (err) {
        console.error(err);
        setStatus("Error, " + err.message, "error");
      }
    }

    function setActiveChip(range) {
      const chips = chipsContainer.querySelectorAll(".chip");
      chips.forEach((chip) => {
        if (chip.dataset.range === range) {
          chip.classList.add("active");
        } else {
          chip.classList.remove("active");
        }
      });
    }

    function setStatus(text, type) {
      statusTextEl.textContent = text;
      statusTextEl.classList.remove("error", "loading");
      if (type === "error") {
        statusTextEl.classList.add("error");
      } else if (type === "loading") {
        statusTextEl.classList.add("loading");
      }
    }

    chipsContainer.addEventListener("click", (event) => {
      const button = event.target.closest(".chip");
      if (!button) return;
      const range = button.dataset.range;
      if (!range) return;
      loadRange(range);
    });

    // initial load
    loadRange("today");
  </script>
</body>
</html>
