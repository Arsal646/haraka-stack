<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Email Count Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: #fafafa;
      color: #111827;
      padding: 24px 16px;
      min-height: 100vh;
    }

    .container {
      max-width: 540px;
      margin: 0 auto;
    }

    .header {
      margin-bottom: 20px;
    }

    .title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 6px;
    }

    .title {
      font-size: 20px;
      font-weight: 600;
      letter-spacing: -0.025em;
      color: #0f172a;
    }

    .tz-badge {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 6px;
      background: #f1f5f9;
      color: #64748b;
      white-space: nowrap;
      font-weight: 500;
    }

    .subtitle {
      font-size: 12px;
      color: #94a3b8;
      font-weight: 400;
    }

    .filters-card {
      background: #ffffff;
      border-radius: 12px;
      padding: 14px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      margin-bottom: 14px;
      border: 1px solid #f1f5f9;
    }

    .filters-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .filters-title {
      font-size: 11px;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .filters-helper {
      font-size: 10px;
      color: #cbd5e1;
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .chip {
      padding: 7px 13px;
      font-size: 12px;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
      background: #f8fafc;
      color: #475569;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      font-weight: 500;
    }

    .chip:hover {
      background: #f1f5f9;
      border-color: #cbd5e1;
    }

    .chip.active {
      background: #0f172a;
      color: #ffffff;
      border-color: #0f172a;
    }

    .card {
      background: #ffffff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      border: 1px solid #f1f5f9;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid #f8fafc;
    }

    .card-title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
      color: #0f172a;
      letter-spacing: -0.01em;
    }

    .card-range-label {
      font-size: 11px;
      color: #64748b;
      font-weight: 500;
    }

    .card-range-detail {
      font-size: 10px;
      color: #94a3b8;
    }

    .badge-pill {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 4px 9px;
      border-radius: 6px;
      font-size: 10px;
      color: #64748b;
      background: #f8fafc;
      font-weight: 500;
    }

    .dot {
      width: 5px;
      height: 5px;
      border-radius: 999px;
      background: #10b981;
    }

    .count-row {
      display: flex;
      align-items: baseline;
      gap: 8px;
      margin-bottom: 12px;
    }

    .count-value {
      font-size: 36px;
      font-weight: 700;
      letter-spacing: -0.03em;
      color: #0f172a;
    }

    .count-unit {
      font-size: 12px;
      color: #94a3b8;
      font-weight: 500;
    }

    .status-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      padding-bottom: 16px;
      border-bottom: 1px solid #f8fafc;
    }

    .status {
      font-size: 11px;
      color: #94a3b8;
    }

    .status.error {
      color: #dc2626;
    }

    .status.loading {
      color: #3b82f6;
    }

    .refresh-hint {
      font-size: 10px;
      color: #cbd5e1;
    }

    .top-sender-block {
      margin-top: 16px;
      padding: 12px;
      border-radius: 8px;
      background: #f8fafc;
      border: 1px solid #f1f5f9;
    }

    .top-sender-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .top-sender-label {
      font-size: 11px;
      font-weight: 600;
      color: #475569;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .top-sender-note {
      font-size: 10px;
      color: #cbd5e1;
    }

    .top-sender-list {
      display: flex;
      flex-direction: column;
      gap: 1px;
    }

    .top-sender-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      font-size: 11px;
    }

    .top-sender-row:not(:last-child) {
      border-bottom: 1px solid #f1f5f9;
    }

    .top-sender-email {
      color: #0f172a;
      font-weight: 500;
    }

    .top-sender-count {
      font-size: 10px;
      color: #94a3b8;
      font-weight: 500;
    }

    .breakdown {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #f8fafc;
    }

    .breakdown-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .breakdown-title {
      font-size: 11px;
      font-weight: 600;
      color: #475569;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .breakdown-muted {
      font-size: 10px;
      color: #cbd5e1;
    }

    .breakdown-list {
      max-height: 200px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 1px;
    }

    .breakdown-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      font-size: 11px;
    }

    .breakdown-row:not(:last-child) {
      border-bottom: 1px solid #f8fafc;
    }

    .breakdown-date {
      color: #475569;
      font-weight: 500;
    }

    .breakdown-count {
      font-weight: 600;
      color: #0f172a;
    }

    @media (max-width: 480px) {
      body {
        padding: 16px 12px;
      }

      .card {
        padding: 16px;
      }

      .count-value {
        font-size: 32px;
      }

      .title {
        font-size: 18px;
      }

      .filters-card {
        padding: 12px;
      }
    }

    .breakdown-list::-webkit-scrollbar {
      width: 6px;
    }

    .breakdown-list::-webkit-scrollbar-track {
      background: #f8fafc;
      border-radius: 3px;
    }

    .breakdown-list::-webkit-scrollbar-thumb {
      background: #e2e8f0;
      border-radius: 3px;
    }

    .breakdown-list::-webkit-scrollbar-thumb:hover {
      background: #cbd5e1;
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="title-row">
        <h1 class="title">Email Count Dashboard</h1>
        <span class="tz-badge">UTC+4, Dubai time</span>
      </div>
      <p class="subtitle">
        Smooth overview of how many emails your system received in each date range.
      </p>
    </header>

    <section class="filters-card">
      <div class="filters-header">
        <span class="filters-title">Date filters</span>
        <span class="filters-helper">Choose a range to update the numbers.</span>
      </div>
      <div class="chip-row" id="range-chips">
        <button class="chip active" data-range="today" id="chip-today">Today</button>
        <button class="chip" data-range="yesterday" id="chip-yesterday">Yesterday</button>
        <button class="chip" data-range="week" id="chip-week">Last 7 days</button>
        <button class="chip" data-range="month" id="chip-month">Last 30 days</button>
      </div>
    </section>

    <section class="card">
      <div class="card-header">
        <div class="card-title-block">
          <span class="card-title">Email overview</span>
          <span class="card-range-label" id="range-label">Today</span>
          <span class="card-range-detail" id="range-detail"></span>
        </div>
        <span class="badge-pill">
          <span class="dot"></span>
          Live summary
        </span>
      </div>

      <div class="count-row">
        <span class="count-value" id="count-value">0</span>
        <span class="count-unit">emails</span>
      </div>

      <div class="status-row">
        <p class="status" id="status-text">Loading data, please wait.</p>
        <p class="refresh-hint">Auto refresh when you change the filter.</p>
      </div>

      <div class="top-sender-block">
        <div class="top-sender-header">
          <span class="top-sender-label">Top senders</span>
          <span class="top-sender-note">Only senders with more than 2 emails.</span>
        </div>
        <div id="top-sender-list" class="top-sender-list">
          <div class="top-sender-row">
            <span>No sender data yet for this range.</span>
          </div>
        </div>
      </div>

      <div class="breakdown">
        <div class="breakdown-header">
          <span class="breakdown-title">Daily breakdown</span>
          <span class="breakdown-muted" id="breakdown-caption">
            From current day to previous days.
          </span>
        </div>
        <div class="breakdown-list" id="breakdown-list"></div>
      </div>
    </section>
  </div>

  <script>
    function abuDhabiNow() {
      const now = new Date();
      const parts = new Intl.DateTimeFormat("en-US", {
        timeZone: "Asia/Dubai",
        year: "numeric",
        month: "numeric",
        day: "numeric",
        hour: "numeric",
        minute: "numeric",
        second: "numeric"
      }).formatToParts(now);

      const get = (type) => parseInt(parts.find((p) => p.type === type).value, 10);

      return new Date(
        get("year"),
        get("month") - 1,
        get("day"),
        get("hour"),
        get("minute"),
        get("second")
      );
    }

    const chipsContainer = document.getElementById("range-chips");
    const countValueEl = document.getElementById("count-value");
    const statusTextEl = document.getElementById("status-text");
    const rangeLabelEl = document.getElementById("range-label");
    const rangeDetailEl = document.getElementById("range-detail");
    const breakdownListEl = document.getElementById("breakdown-list");
    const topSenderListEl = document.getElementById("top-sender-list");

    const chipToday = document.getElementById("chip-today");
    const chipYesterday = document.getElementById("chip-yesterday");
    const chipWeek = document.getElementById("chip-week");
    const chipMonth = document.getElementById("chip-month");

    function formatShort(date) {
      return date.toLocaleDateString("en-US", {
        day: "numeric",
        month: "short"
      });
    }

    function formatShortWithYear(date) {
      return date.toLocaleDateString("en-US", {
        day: "numeric",
        month: "short",
        year: "numeric"
      });
    }

    function formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, "0");
      const day = String(date.getDate()).padStart(2, "0");
      return year + "-" + month + "-" + day;
    }

    function updateChipLabels() {
      const now = abuDhabiNow();
      const yesterday = new Date(now);
      yesterday.setDate(yesterday.getDate() - 1);

      chipToday.textContent = "Today (" + formatShort(now) + ")";
      chipYesterday.textContent = "Yesterday (" + formatShort(yesterday) + ")";

      const weekEnd = formatShort(now);
      const weekStart = new Date(now);
      weekStart.setDate(weekStart.getDate() - 6);

      chipWeek.textContent =
        "Last 7 days (" + formatShort(weekStart) + " to " + weekEnd + ")";

      const monthEnd = formatShort(now);
      const monthStart = new Date(now);
      monthStart.setDate(monthStart.getDate() - 29);

      chipMonth.textContent =
        "Last 30 days (" + formatShort(monthStart) + " to " + monthEnd + ")";
    }

    updateChipLabels();

    function getDatesForRange(range) {
      const today = abuDhabiNow();
      today.setHours(0, 0, 0, 0);

      if (range === "today") {
        return [new Date(today)];
      }

      if (range === "yesterday") {
        const y = new Date(today);
        y.setDate(y.getDate() - 1);
        return [y];
      }

      if (range === "week") {
        const dates = [];
        for (let i = 0; i < 7; i++) {
          const d = new Date(today);
          d.setDate(d.getDate() - i);
          dates.push(d);
        }
        return dates;
      }

      if (range === "month") {
        const dates = [];
        for (let i = 0; i < 30; i++) {
          const d = new Date(today);
          d.setDate(d.getDate() - i);
          dates.push(d);
        }
        return dates;
      }

      return [new Date(today)];
    }

    function labelForRange(range) {
      if (range === "today") return "Today";
      if (range === "yesterday") return "Yesterday";
      if (range === "week") return "Last 7 days";
      if (range === "month") return "Last 30 days";
      return "Today";
    }

    function detailForRange(dates) {
      if (!dates.length) return "";
      const start = dates[dates.length - 1];
      const end = dates[0];
      if (start.toDateString() === end.toDateString()) {
        return formatShortWithYear(start);
      }
      return formatShortWithYear(start) + " to " + formatShortWithYear(end);
    }

    async function fetchMetricsForDate(str) {
      const res = await fetch("/email-count?date=" + encodeURIComponent(str));
      if (!res.ok) {
        throw new Error("API " + res.status);
      }
      const data = await res.json();
      const senders = Array.isArray(data.senders) ? data.senders : [];

      return {
        count: data.count || 0,
        senders
      };
    }

    function setActiveChip(range) {
      const chips = chipsContainer.querySelectorAll(".chip");
      chips.forEach((chip) => {
        chip.classList.toggle("active", chip.dataset.range === range);
      });
    }

    function setStatus(text, type) {
      statusTextEl.textContent = text;
      statusTextEl.className = "status" + (type ? " " + type : "");
    }

    function renderBreakdown(dateObjs, metrics) {
      breakdownListEl.innerHTML = "";

      if (!dateObjs.length) {
        const row = document.createElement("div");
        row.className = "breakdown-row";
        row.innerHTML =
          '<span class="breakdown-date">No data</span>' +
          '<span class="breakdown-count">0</span>';
        breakdownListEl.appendChild(row);
        return;
      }

      for (let i = 0; i < dateObjs.length; i++) {
        const d = dateObjs[i];
        const m = metrics[i];

        const row = document.createElement("div");
        row.className = "breakdown-row";
        row.innerHTML =
          '<span class="breakdown-date">' +
          formatShortWithYear(d) +
          "</span>" +
          '<span class="breakdown-count">' +
          m.count +
          "</span>";
        breakdownListEl.appendChild(row);
      }
    }

    function renderTopSenders(metrics) {
      topSenderListEl.innerHTML = "";

      const map = {};
      metrics.forEach((m) => {
        m.senders.forEach((s) => {
          if (!s.email) return;
          map[s.email] = (map[s.email] || 0) + (s.count || 0);
        });
      });

      const entries = Object.entries(map)
        .map(([email, total]) => ({ email, total }))
        .filter((item) => item.total > 2)
        .sort((a, b) => b.total - a.total);

      if (!entries.length) {
        const row = document.createElement("div");
        row.className = "top-sender-row";
        row.innerHTML = "<span>No sender with more than 2 emails.</span>";
        topSenderListEl.appendChild(row);
        return;
      }

      entries.forEach((item) => {
        const row = document.createElement("div");
        row.className = "top-sender-row";
        row.innerHTML =
          '<span class="top-sender-email">' +
          item.email +
          "</span>" +
          '<span class="top-sender-count">' +
          item.total +
          " emails</span>";
        topSenderListEl.appendChild(row);
      });
    }

    async function loadRange(range) {
      try {
        setStatus("Loading data, please wait.", "loading");
        setActiveChip(range);
        rangeLabelEl.textContent = labelForRange(range);

        const dateObjs = getDatesForRange(range);
        rangeDetailEl.textContent = detailForRange(dateObjs);

        const promises = dateObjs.map((d) =>
          fetchMetricsForDate(formatDate(d))
        );
        const metrics = await Promise.all(promises);

        const total = metrics.reduce((sum, m) => sum + m.count, 0);
        countValueEl.textContent = total.toString();

        renderBreakdown(dateObjs, metrics);
        renderTopSenders(metrics);

        setStatus("Updated just now.", "normal");
      } catch (err) {
        console.error(err);
        setStatus("Error, " + err.message, "error");
        breakdownListEl.innerHTML = "";
        topSenderListEl.innerHTML =
          '<div class="top-sender-row"><span>No data for this range.</span></div>';
      }
    }

    chipsContainer.addEventListener("click", (e) => {
      const btn = e.target.closest(".chip");
      if (!btn) return;
      loadRange(btn.dataset.range);
    });

    loadRange("today");
  </script>
</body>
</html>